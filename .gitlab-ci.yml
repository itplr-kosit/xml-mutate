default:
  image: maven:3.8.3-openjdk-17

stages:
  - build
  - deploy
  - release

variables:
  MAVEN_CLI_OPTS: "--batch-mode -Dmaven.repo.local=repository -Dfile.encoding=UTF-8"
  XSE_COMPONENT_PROJECT_ID: "356"
  XSE_COMPONENT_PACKAGE_REGISTRY_URL_PREFIX: "${CI_API_V4_URL}/projects/${XSE_COMPONENT_PROJECT_ID}/packages/maven"

cache:
  paths:
    - repository

build-job:
  stage: build
  script:
    - echo "Building xml-mutate version from pom.xml"
    - mvn $MAVEN_CLI_OPTS verify
    - echo "Generating deployment metadata"
    - mkdir -p build
    - |
      # Extract version, groupId, and artifactId from pom.xml
      PROJECT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
      GROUP_ID=$(mvn help:evaluate -Dexpression=project.groupId -q -DforceStdout)
      ARTIFACT_ID=$(mvn help:evaluate -Dexpression=project.artifactId -q -DforceStdout)
      PACKAGE_BINARY="${ARTIFACT_ID}-${PROJECT_VERSION}.jar"
      MAVEN_PACKAGE_NAME=$(echo ${GROUP_ID} | sed 's/\./\//g')/${ARTIFACT_ID}
      
      # Write to build.env
      echo "GROUP_ID=${GROUP_ID}" > build/build.env
      echo "ARTIFACT_ID=${ARTIFACT_ID}" >> build/build.env
      echo "PACKAGE_VERSION=${PROJECT_VERSION}" >> build/build.env
      echo "PACKAGE_BINARY=${PACKAGE_BINARY}" >> build/build.env
      echo "MAVEN_PACKAGE_NAME=${MAVEN_PACKAGE_NAME}" >> build/build.env
    - cat build/build.env
  artifacts:
    name: xml-mutate-${CI_COMMIT_REF_NAME}
    paths:
      - target/*.jar
      - build/
    expire_in: 1 day
    reports:
      junit:
        - target/surefire-reports/*.xml
        - target/failsafe-reports/*.xml
      dotenv: build/build.env

deploy-to-xse-component-repository:
  stage: deploy
  image: maven:3.8.5-openjdk-17
  variables:
    REPO_ID: "xse-component-repository"
    FILE_PATH: "target/${PACKAGE_BINARY}"
  rules:
    - if: $CI_COMMIT_TAG
  dependencies:
    - build-job
  script:
    - echo "Deploying ${PACKAGE_BINARY} to xse-component-repository"
    - echo "GROUP_ID=${GROUP_ID}, ARTIFACT_ID=${ARTIFACT_ID}, VERSION=${PACKAGE_VERSION}"
    - |
      echo "<settings><servers><server><id>${REPO_ID}</id><configuration><httpHeaders><property><name>Job-Token</name><value>${CI_JOB_TOKEN}</value></property></httpHeaders></configuration></server></servers></settings>" > /tmp/settings.xml
    - mvn deploy:deploy-file
      -Durl=${XSE_COMPONENT_PACKAGE_REGISTRY_URL_PREFIX}
      -DrepositoryId=${REPO_ID}
      -Dfile=${FILE_PATH}
      -DgroupId=${GROUP_ID}
      -DartifactId=${ARTIFACT_ID}
      -Dversion=${PACKAGE_VERSION}
      -Dpackaging=jar
      --settings /tmp/settings.xml

release_job:
  stage: release
  image: registry.gitlab.com/gitlab-org/cli:latest
  rules:
    - if: $CI_COMMIT_TAG
  dependencies:
    - build-job
  script:
    - echo "Creating release for tag $CI_COMMIT_TAG with version ${PACKAGE_VERSION}"
  release:
    name: 'Release $CI_COMMIT_TAG'
    description: 'xml-mutate release $CI_COMMIT_TAG'
    tag_name: '$CI_COMMIT_TAG'
    ref: '$CI_COMMIT_TAG'
    assets:
      links:
        - name: 'JAR Binary'
          url: '${XSE_COMPONENT_PACKAGE_REGISTRY_URL_PREFIX}/${MAVEN_PACKAGE_NAME}/${PACKAGE_VERSION}/${PACKAGE_BINARY}'
          link_type: 'package'
